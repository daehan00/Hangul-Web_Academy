async function loadSlidesFromJson(jsonPath, selectedWord) {
    try {
        const response = await fetch(jsonPath);
        // console.log(response);
        const data = await response.json();

        const slidesContainer = document.querySelector(".slides");
        const titleEl = document.querySelector(".main_title");

        // ‚úÖ Ìó§Îçî ÌÉÄÏù¥ÌãÄ ÏóÖÎç∞Ïù¥Ìä∏ (Ï∂îÍ∞Ä Î∂ÄÎ∂Ñ)
        const headerTitleEl = document.querySelector("#title h1");
        if (headerTitleEl && data.introTitle) {
            headerTitleEl.innerHTML = data.introTitle;
        }

        // ‚úÖ ÏÑ†ÌÉùÌïú Îã®Ïñ¥Í∞Ä ÏûàÏúºÎ©¥ entriesÏóêÏÑú Ï∞æÍ≥† ÏóÜÏúºÎ©¥ Ï†ÑÏ≤¥ Ïä¨ÎùºÏù¥Îìú ÏÇ¨Ïö©
        let slides = [];
        if (data.entries && Array.isArray(data.entries)) {
            if (!selectedWord) {
                // ‚úÖ ÏùΩÍ∏∞/Îì£Í∏∞ Îì± Îã®Ïùº Ìï≠Î™©Ïù∏ Í≤ΩÏö∞ Ï≤´ entryÎ•º Î°úÎìú
                selectedWord = data.entries[0].title;
            }
            const matchedEntry = data.entries.find(entry => entry.title === selectedWord);
            if (matchedEntry && matchedEntry.slides) {
                slides = matchedEntry.slides;
                if (titleEl) titleEl.textContent = matchedEntry.title;
            } else {
                throw new Error("ÏÑ†ÌÉùÎêú Îã®Ïñ¥Ïùò Ïä¨ÎùºÏù¥ÎìúÎ•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
            }
        } else if (data.slides && Array.isArray(data.slides)) {
            slides = data.slides;
            if (titleEl && data.title) titleEl.textContent = data.title;
        } else {
            throw new Error("Ïú†Ìö®Ìïú Ïä¨ÎùºÏù¥Îìú Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
        }
        // console.log("ÏÑ†ÌÉùÎêú Îã®Ïñ¥:", selectedWord);
        // console.log("ÏóîÌä∏Î¶¨ Ï†úÎ™© Î™©Î°ù:", data.entries.map(e => e.title));

        slides.forEach(slide => {
            const slideEl = document.createElement("div");
            slideEl.classList.add(`slide_${slide.type}`, "slide");

            if (slide.subtitle) {
                const subtitleEl = document.createElement("div");
                subtitleEl.className = "slide_subtitle";
                subtitleEl.textContent = slide.subtitle;
                slideEl.appendChild(subtitleEl);
            }

            const main = document.createElement("div");
            main.className = "slide_main";

            if (slide.type === "image" || slide.image) {
                const imageBox = document.createElement("div");
                imageBox.className = "slide_main_image";
                const img = document.createElement("img");
                img.src = slide.image;
                imageBox.appendChild(img);
                main.appendChild(imageBox);
            }

            if (slide.type === "video" && slide.videoUrl) {
                const iframe = document.createElement("iframe");
                iframe.src = slide.videoUrl;
                iframe.allowFullscreen = true;
                iframe.width = "300";
                iframe.height = "150";
                iframe.frameBorder = "0";
                main.appendChild(iframe);
            }

            if (slide.text) {
                const textBox = document.createElement("div");
                textBox.className = slide.type === "video" ? "slide_video_main_text" : "slide_main_text";
            
                const parser = new DOMParser();
                const doc = parser.parseFromString(`<div>${slide.text}</div>`, 'text/html');
                const container = doc.body.firstChild;
            
                if (selectedWord) {
                    const regex = new RegExp(`(${selectedWord})`, 'gi');
            
                    function highlightTextNodes(node) {
                        node.childNodes.forEach(child => {
                            if (child.nodeType === Node.TEXT_NODE) {
                                const original = child.textContent;
                                if (regex.test(original)) {
                                    const replaced = original.replace(regex, `<span style="color:red; font-weight:bold;">$1</span>`);
                                    const spanContainer = document.createElement('span');
                                    spanContainer.innerHTML = replaced;
                                    node.replaceChild(spanContainer, child);
                                }
                            } else if (child.nodeType === Node.ELEMENT_NODE) {
                                highlightTextNodes(child);
                            }
                        });
                    }
            
                    highlightTextNodes(container);
                }
            
                textBox.appendChild(container);
                main.appendChild(textBox);
            }

            if (slide.sound && typeof slide.sound === "string") {
                const soundBtn = document.createElement("button");
                soundBtn.className = "sound";
            
                const img = document.createElement("img");
                img.src = "images/icons/megaphone.svg";
                soundBtn.appendChild(img);
            
                const audio = document.createElement("audio");
                audio.src = slide.sound;
            
                // ‚úÖ ÏùºÏãúÏ†ïÏßÄ/Ïû¨ÏÉù ÌÜ†Í∏Ä
                soundBtn.addEventListener("click", () => {
                    if (audio.paused) {
                        audio.play();
                    } else {
                        audio.pause();
                    }
                });
            
                main.appendChild(soundBtn);
                main.appendChild(audio);
            }

            slideEl.appendChild(main);

            const footer = document.createElement("div");
            footer.className = "slide_footer";

            if (slide.type === "quiz") {
                const input = document.createElement("input");
                input.className = "quiz-input";
                input.setAttribute("data-answer", slide.answer);
                input.placeholder = "ÎãµÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!";

                const button = document.createElement("button");
                button.className = "quiz-submit";
                button.textContent = "Ï†úÏ∂ú";

                footer.appendChild(input);
                footer.appendChild(button);
            } else {
                footer.textContent = "ÏïÑÎûòÎ°ú ÎÑòÍ∏∞ÏÑ∏Ïöî";
            }

            slideEl.appendChild(footer);
            slidesContainer.appendChild(slideEl);
        });
    } catch (err) {
        // console.error("Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:", err);
    }
}

// ‚úÖ intro.htmlÏóêÏÑú ÏÇ¨Ïö©Ìï† Îç∞Ïù¥ÌÑ∞ Î°úÎî©
async function loadIntroFromJson(jsonPath) {
    try {
        const response = await fetch(jsonPath);
        // console.log(response);
        const data = await response.json();

        // Ï†úÎ™© ÏÑ§Ï†ï
        const titleEl = document.querySelector('#title h1');
        if (titleEl && data.introTitle) {
            titleEl.innerHTML = data.introTitle;
        }

        // ÏÑ§Î™Ö ÌÖçÏä§Ìä∏
        const infoEl = document.querySelector('.main_information h3');
        if (infoEl && data.introText) {
            infoEl.innerHTML = data.introText;
        }

        // ÏÜåÍ∞ú ÏòÅÏÉÅ
        const videoEl = document.querySelector('#main_video');
        if (videoEl && data.introVideo) {
            videoEl.src = data.introVideo;
        }

        // Ïñ¥Ìúò Î≤ÑÌäº ÏÉùÏÑ±
        const mainWordBox = document.querySelector('.main_word');
        const extendWordBox = document.querySelector('.extend_word');

        data.words.main.forEach(word => {
            const btn = document.createElement('button');
            btn.className = 'word';
            btn.textContent = word;
            btn.addEventListener('click', () => {
                window.location.href = `main.html?category=${data.category}&word=${word}`;
            });
            mainWordBox.appendChild(btn);
        });

        data.words.extend.forEach(word => {
            const btn = document.createElement('button');
            btn.className = 'word';
            btn.textContent = word;
            extendWordBox.appendChild(btn);
        });
    } catch (err) {
        // console.error("Ïù∏Ìä∏Î°ú Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ïã§Ìå®:", err);
    }
}

document.addEventListener('DOMContentLoaded', () => {
    // ‚úÖ Í≥µÌÜµ ÌååÎùºÎØ∏ÌÑ∞ ÏàòÏßë
    const params = new URLSearchParams(window.location.search);
    const category = params.get("category") || "word";
    const word = params.get("word") || null;
    const jsonPath = `data/${category}.json`;

    // main.htmlÏö© Î°úÎî©
    if (document.querySelector('.main_practice_page')) {
        loadSlidesFromJson(jsonPath, word);
    }

    // intro.htmlÏö© Î°úÎî©
    if (document.querySelector('.intro_page')) {
        loadIntroFromJson(jsonPath);

        // Î≤ÑÌäº ÌÅ¥Î¶≠ Ïãú mainÏúºÎ°ú Ïù¥Îèô Ï≤òÎ¶¨
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('word')) {
                const selectedWord = e.target.textContent;
                window.location.href = `main.html?category=${category}&word=${encodeURIComponent(selectedWord)}`;
            }
        });
    }
    // ÌïòÎìúÏΩîÎî©Îêú Î≤ÑÌäºÎì§ÏóêÎèÑ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Î∂ÄÏó¨
    document.querySelectorAll('.word').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const selectedWord = e.target.dataset.word || e.target.textContent;
            window.location.href = `main.html?category=${category}&word=${encodeURIComponent(selectedWord)}`;
        });
    });
});

const slidesContainer = document.querySelector(".slides");

if (slidesContainer) {
    const observer = new MutationObserver((mutationsList, observer) => {
        const slideCount = slidesContainer.querySelectorAll(':scope > div').length;
        if (slideCount > 0 && typeof window.initializeSlideEvents === 'function') {
            // console.log("üîç Ïä¨ÎùºÏù¥Îìú Í∞êÏßÄ ÏôÑÎ£å, Ïù¥Î≤§Ìä∏ Î∞îÏù∏Îî©");
            window.initializeSlideEvents();
            observer.disconnect(); // Ï§ëÎ≥µ Î∞îÏù∏Îî© Î∞©ÏßÄ
        }
    });

    observer.observe(slidesContainer, { childList: true });
}